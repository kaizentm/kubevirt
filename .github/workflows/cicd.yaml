name: CICD Pipeline

on:
  push:
    branches: ["ise"]
  workflow_dispatch:
    inputs:
      registry:
        description: 'Container registry to push images to'
        required: false
        default: 'ghcr.io'
        type: string
      rpm_image_tag:
        description: 'Tag for custom libvirt and QEMU RPMs images'
        required: false
        default: 'qemu-mshv'
        type: string
      registry_username:
        description: 'Username for container registry (only needed for non-GHCR registries)'
        required: false
        default: ''
        type: string
      registry_password:
        description: 'Password for container registry (only needed for non-GHCR registries)'
        required: false
        default: ''
        type: string
  
jobs:
  quality-check:
    uses: ./.github/workflows/pr.yaml
        
  build-push-images:
    uses: ./.github/workflows/build-images.yaml
    needs: [quality-check]
    with:
      registry: ${{ inputs.registry }}
      rpm_image_tag: ${{ inputs.rpm_image_tag }}
      registry_username: ${{ inputs.registry_username }}
      registry_password: ${{ inputs.registry_password }}
      docker_tag: ${{ vars.VERSION }}-l1vh.${{ github.run_number }}
    secrets: inherit

  dev:
    uses: ./.github/workflows/deploy.yaml
    with:
      environment: dev
      registry: ${{ needs.build-push-images.outputs.registry }}
      image_tag: ${{ needs.build-push-images.outputs.image_tag }}
    secrets: inherit
    needs: [build-push-images]

  test-kvm:
    uses: ./.github/workflows/deploy.yaml
    with:
      environment: test-kvm
      registry: ${{ needs.build-push-images.outputs.registry }}
      image_tag: ${{ needs.build-push-images.outputs.image_tag }}
    secrets: inherit
    needs: [build-push-images, dev]

  test-emulation:
    uses: ./.github/workflows/deploy.yaml
    with:
      environment: test-emulation
      registry: ${{ needs.build-push-images.outputs.registry }}
      image_tag: ${{ needs.build-push-images.outputs.image_tag }}
    secrets: inherit
    needs: [build-push-images, dev]

  test-mshv:
    uses: ./.github/workflows/deploy.yaml
    with:
      environment: test-mshv
      registry: ${{ needs.build-push-images.outputs.registry }}
      image_tag: ${{ needs.build-push-images.outputs.image_tag }}
    secrets: inherit
    needs: [build-push-images, dev]
